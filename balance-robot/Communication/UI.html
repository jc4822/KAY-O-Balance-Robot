<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Robot Control UI with WebRTC (No-Trickle ICE)</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #f0f0f0;
      touch-action: none;
      user-select: none;
      font-family: sans-serif;
    }
    #gameArea {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    #infoPanel {
      position: absolute;
      top: 2vmin;
      left: 2vmin;
      background: rgba(255, 255, 255, 0.85);
      padding: 1.5vmin 2vmin;
      border-radius: 1vmin;
      box-shadow: 0 0.5vmin 1.5vmin rgba(0, 0, 0, 0.2);
      z-index: 10;
      font-size: 2.5vmin;
    }
    #infoPanel p {
      margin: 1vmin 0;
    }
    #robotSelector {
      position: absolute;
      top: 2vmin;
      right: 2vmin;
      z-index: 10;
      text-align: right;
      font-size: 2.5vmin;
    }
    #toggleSelector {
      background: #007bff;
      color: white;
      border: none;
      padding: 1.5vmin 2vmin;
      border-radius: 1vmin;
      cursor: pointer;
    }
    #selectorOptions {
      display: none;
      margin-top: 1vmin;
      background: rgba(255, 255, 255, 0.9);
      padding: 2vmin;
      border-radius: 1vmin;
      box-shadow: 0 0.5vmin 1.5vmin rgba(0, 0, 0, 0.2);
      text-align: left;
    }
    #selectorOptions label {
      display: block;
      margin-bottom: 1.5vmin;
      cursor: pointer;
    }
    #cameraFeed {
      position: absolute;
      top: 20vh;
      left: 20vw;
      width: 60vw;
      height: 60vh;
      border: 0.5vmin dashed #666;
      border-radius: 1vmin;
      background: #000;
      z-index: 5;
    }
    #cameraFeed video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #controls {
      position: absolute;
      bottom: 5vmin;
      left: 5vmin;
      display: grid;
      grid-template-areas: ". up ." "left . right" ". down .";
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      gap: 1vmin;
      z-index: 10;
    }
    .ctrl-btn {
      width: 8vmin;
      height: 8vmin;
      border-radius: 50%;
      background: #007bff;
      color: white;
      font-size: 4vmin;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      touch-action: none;
      cursor: pointer;
    }
    #btnForward { grid-area: up; }
    #btnBackward { grid-area: down; }
    #btnLeft { grid-area: left; }
    #btnRight { grid-area: right; }
    .rotate-90, .rotate-270 { display: inline-block; }
    .rotate-90 { transform: rotate(90deg); }
    .rotate-270 { transform: rotate(270deg); }
  </style>
</head>
<body>
  <div id="gameArea">
    <div id="infoPanel">
      <p>Battery: <span id="battery">â€”</span></p>
      <p>PID â†’ P: <span id="pidP">â€”</span>, I: <span id="pidI">â€”</span>, D: <span id="pidD">â€”</span></p>
    </div>

    <div id="robotSelector">
      <button id="toggleSelector">Robot 1 (offline) â–¾</button>
      <div id="selectorOptions">
        <label><input type="radio" name="robot" value="1" checked> Robot 1 (<span id="status1">offline</span>)</label>
        <label><input type="radio" name="robot" value="2"> Robot 2 (<span id="status2">offline</span>)</label>
      </div>
    </div>

    <div id="cameraFeed">
      <video id="videoStream" autoplay playsinline></video>
    </div>

    <div id="controls">
      <button class="ctrl-btn" id="btnForward">â–²</button>
      <button class="ctrl-btn" id="btnLeft"><span class="rotate-90">â†¶</span></button>
      <button class="ctrl-btn" id="btnRight"><span class="rotate-270">â†·</span></button>
      <button class="ctrl-btn" id="btnBackward">â–¼</button>
    </div>
  </div>

  <script>
    // â”€â”€â”€ Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Signal to the same host that served this page (the Pi), port 8000:
    const SIGNALING_BASE = `http://${window.location.hostname}:8000`;
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    let pc = null;
    let dataChannel = null;

    // â”€â”€â”€ 1) Define sendControl() globally â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function sendControl(direction) {
      if (dataChannel && dataChannel.readyState === "open") {
        const msg = {
          robotId:   document.querySelector('input[name="robot"]:checked').value,
          action:    "move",
          direction: direction,
          timestamp: new Date().toISOString()
        };
        dataChannel.send(JSON.stringify(msg));
        console.log("Sent control â†’", msg);
      } else {
        console.warn("Cannot sendControl; dataChannel not open");
      }
    }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // â”€â”€â”€ 2) Set up WebRTC / DataChannel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function startWebRTC() {
      pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      pc.addTransceiver("video", { direction: "recvonly" });

      dataChannel = pc.createDataChannel("control", { ordered: true });
      dataChannel.onopen = () => {
        console.log("â–¶ï¸ DataChannel is now OPEN");
        // Mark selected robot as online
        const sel = document.querySelector('input[name="robot"]:checked');
        sel.parentNode.querySelector('span').textContent = "online";
      };
      dataChannel.onmessage = (evt) => {
        console.log("ðŸ›°ï¸ Telemetry from Pi:", evt.data);
        try {
          const telemetry = JSON.parse(evt.data);
          document.getElementById("battery").textContent = telemetry.battery + "%";
          document.getElementById("pidP").textContent    = telemetry.pidP;
          document.getElementById("pidI").textContent    = telemetry.pidI;
          document.getElementById("pidD").textContent    = telemetry.pidD;
        } catch (e) {
          console.warn("Invalid telemetry JSON:", e);
        }
      };
      dataChannel.onclose = () => {
        console.log("ðŸ”Œ DataChannel closed");
        const sel = document.querySelector('input[name="robot"]:checked');
        sel.parentNode.querySelector('span').textContent = "offline";
      };

      pc.ontrack = (ev) => {
        const video = document.getElementById("videoStream");
        if (!video.srcObject) {
          video.srcObject = ev.streams[0];
        }
      };

      // 2a) Create an SDP offer and wait for ICE gathering
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      await new Promise(resolve => {
        if (pc.iceGatheringState === "complete") {
          resolve();
        } else {
          pc.onicegatheringstatechange = () => {
            if (pc.iceGatheringState === "complete") {
              pc.onicegatheringstatechange = null;
              resolve();
            }
          };
        }
      });

      // 2b) POST the complete SDP to /offer on the Pi
      let resp;
      try {
        resp = await fetch(`${SIGNALING_BASE}/offer`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            peer_id: "browser1",
            type:    pc.localDescription.type,
            sdp:     pc.localDescription.sdp
          })
        });
      } catch (networkError) {
        console.error("Network error when calling /offer:", networkError);
        return;
      }

      if (!resp.ok) {
        const text = await resp.text();
        console.error("Offer failed", resp.status, text);
        return;
      }

      let answer;
      try {
        answer = await resp.json();
      } catch (jsonError) {
        console.error("Failed to parse JSON from /offer:", jsonError);
        return;
      }

      await pc.setRemoteDescription(new RTCSessionDescription(answer));
      console.log("WebRTC connection established");
    }

    window.addEventListener("load", () => {
      startWebRTC().catch(e => console.error("startWebRTC() threw:", e));
    });
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // â”€â”€â”€ 3) Attach keydown/keyup listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    console.log("Attaching keydown/keyup listeners");
    document.addEventListener('keydown', e => {
      switch (e.key.toLowerCase()) {
        case 'w': sendControl("forward");  break;
        case 's': sendControl("backward"); break;
        case 'a': sendControl("left");     break;
        case 'd': sendControl("right");    break;
      }
    });
    document.addEventListener('keyup', e => {
      switch (e.key.toLowerCase()) {
        case 'w':
        case 's':
        case 'a':
        case 'd':
          sendControl("stop");
          break;
      }
    });
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // â”€â”€â”€ 4) Attach on-screen button listeners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function bindBtn(id, dirName) {
      const btn = document.getElementById(id);
      console.log(`Binding pointerdown for ${id} â†’ ${dirName}`);
      btn.addEventListener('pointerdown', () => {
        console.log(`${id} pointerdown â†’ sendControl("${dirName}")`);
        sendControl(dirName);
      });
      btn.addEventListener('pointerup', () => {
        console.log(`${id} pointerup â†’ sendControl("stop")`);
        sendControl("stop");
      });
      btn.addEventListener('pointerleave', () => {
        console.log(`${id} pointerleave â†’ sendControl("stop")`);
        sendControl("stop");
      });
    }
    bindBtn('btnForward',  'forward');
    bindBtn('btnBackward', 'backward');
    bindBtn('btnLeft',     'left');
    bindBtn('btnRight',    'right');
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // â”€â”€â”€ 5) Robot selector dropdown logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const toggleBtn = document.getElementById('toggleSelector');
    const opts      = document.getElementById('selectorOptions');
    function updateToggle() {
      const sel = document.querySelector('input[name="robot"]:checked');
      toggleBtn.textContent = sel.parentNode.textContent.trim() + ' â–¾';
    }
    toggleBtn.addEventListener('click', () => {
      opts.style.display = opts.style.display === 'block' ? 'none' : 'block';
    });
    document.querySelectorAll('input[name="robot"]').forEach(r => {
      r.addEventListener('change', () => updateToggle());
    });
    updateToggle();
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  </script>
</body>
</html>
