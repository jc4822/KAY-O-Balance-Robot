<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Robot Control UI with Virtual Buttons</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      background: #f0f0f0;
      touch-action: none;
      user-select: none;
      font-family: sans-serif;
    }
    #gameArea {
      position: relative;
      width: 100vw; height: 100vh;
    }

    /* Info panel (top-left) */
    #infoPanel {
      position: absolute;
      top: 2vmin; left: 2vmin;
      background: rgba(255,255,255,0.85);
      padding: 1.5vmin 2vmin;
      border-radius: 1vmin;
      box-shadow: 0 0.5vmin 1.5vmin rgba(0,0,0,0.2);
      z-index: 10;
      font-size: 2.5vmin;
    }
    #infoPanel p { margin: 1vmin 0; }

    /* Robot selector (top-right) */
    #robotSelector {
      position: absolute;
      top: 2vmin; right: 2vmin;
      z-index: 10; text-align: right;
      font-size: 2.5vmin;
    }
    #toggleSelector {
      background: #007bff;
      color: white;
      border: none;
      padding: 1.5vmin 2vmin;
      border-radius: 1vmin;
      cursor: pointer;
    }
    #selectorOptions {
      display: none;
      margin-top: 1vmin;
      background: rgba(255,255,255,0.9);
      padding: 2vmin;
      border-radius: 1vmin;
      box-shadow: 0 0.5vmin 1.5vmin rgba(0,0,0,0.2);
      text-align: left;
    }
    #selectorOptions label {
      display: block;
      margin-bottom: 1.5vmin;
      cursor: pointer;
    }

    /* Camera feed placeholder (center 60%) */
    #cameraFeed {
      position: absolute;
      top: 20vh; left: 20vw;
      width: 60vw; height: 60vh;
      border: 0.5vmin dashed #666;
      border-radius: 1vmin;
      background: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-size: 3vmin;
      z-index: 5;
    }

    /* Player box (robot) */
    #player {
      position: absolute;
      width: 10vmin; height: 10vmin;
      background: #007bff;
      top: calc(50% - 5vmin);
      left: calc(50% - 5vmin);
      transform-origin: center;
      z-index: 6; /* above cameraFeed */
    }

    /* Virtual button controls (bottom-left) */
    #controls {
      position: absolute;
      bottom: 5vmin; left: 5vmin;
      display: grid;
      grid-template-areas:
        ". up ."
        "left . right"
        ". down .";
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      gap: 1vmin;
      z-index: 10;
    }
    .ctrl-btn {
      width: 8vmin; height: 8vmin;
      border-radius: 50%;
      background: #007bff;
      color: white;
      font-size: 4vmin;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      touch-action: none;
      cursor: pointer;
    }
    #btnForward  { grid-area: up;    }
    #btnBackward { grid-area: down;  }
    #btnLeft     { grid-area: left;  }
    #btnRight    { grid-area: right; }
    
    .rotate-90, .rotate-270 {
      display: inline-block;    /* make transform apply just to the icon */
    }
    .rotate-90 {
      transform: rotate(90deg);
    }
    .rotate-270 {
      transform: rotate(270deg); /* or rotate(-90deg) */
    }
  </style>
</head>
<body>
  <div id="gameArea">
    <div id="infoPanel">
      <p>Battery: <span id="battery">85%</span></p>
      <p>PID → P: <span id="pidP">1.2</span>, I: <span id="pidI">0.05</span>, D: <span id="pidD">0.01</span></p>
    </div>

    <div id="robotSelector">
      <button id="toggleSelector">Robot 1 (offline) ▾</button>
      <div id="selectorOptions">
        <label>
          <input type="radio" name="robot" value="1" checked>
          Robot 1 (<span id="status1">offline</span>)
        </label>
        <label>
          <input type="radio" name="robot" value="2">
          Robot 2 (<span id="status2">offline</span>)
        </label>
      </div>
    </div>

    <div id="cameraFeed">Camera Feed</div>
    <div id="player"></div>

    <div id="controls">
      <button class="ctrl-btn" id="btnForward">▲</button>
      <button class="ctrl-btn" id="btnLeft">
        <span class="rotate-90">↶</span>
      </button>
      <button class="ctrl-btn" id="btnRight">
        <span class="rotate-270">↷</span>
      </button>
      <button class="ctrl-btn" id="btnBackward">▼</button>
    </div>
  </div>

  <script>
    // Robot selector
    const toggleBtn = document.getElementById('toggleSelector');
    const opts      = document.getElementById('selectorOptions');
    function updateToggle() {
      const sel = document.querySelector('input[name="robot"]:checked');
      toggleBtn.textContent = sel.parentNode.textContent.trim() + ' ▾';
    }
    toggleBtn.addEventListener('click', () => {
      opts.style.display = opts.style.display === 'block' ? 'none' : 'block';
    });
    document.querySelectorAll('input[name="robot"]').forEach(r => {
      r.addEventListener('change', () => {
        updateToggle();
        // TODO: notify server/RPi of selection
      });
    });
    updateToggle();

    // Movement state
    let angle = -Math.PI/2;           // start facing "up"
    const speed = Math.min(window.innerWidth, window.innerHeight) * 0.3; // px/sec
    const angularSpeed = Math.PI;     // rad/sec (180°/s)
    let lastTime = performance.now();

    const keys = { up:false, down:false, left:false, right:false };

    // Keyboard handling
    document.addEventListener('keydown', e => {
      switch(e.key.toLowerCase()) {
        case 'w': keys.up    = true; break;
        case 's': keys.down  = true; break;
        case 'a': keys.left  = true; break;
        case 'd': keys.right = true; break;
      }
    });
    document.addEventListener('keyup', e => {
      switch(e.key.toLowerCase()) {
        case 'w': keys.up    = false; break;
        case 's': keys.down  = false; break;
        case 'a': keys.left  = false; break;
        case 'd': keys.right = false; break;
      }
    });

    // Virtual button handling
    function bindBtn(id, keyName) {
      const btn = document.getElementById(id);
      btn.addEventListener('pointerdown', () => { keys[keyName] = true; });
      btn.addEventListener('pointerup',   () => { keys[keyName] = false; });
      btn.addEventListener('pointerleave',() => { keys[keyName] = false; });
    }
    bindBtn('btnForward',  'up');
    bindBtn('btnBackward', 'down');
    bindBtn('btnLeft',     'left');
    bindBtn('btnRight',    'right');

    const player = document.getElementById('player');

    function update(now) {
      const dt = (now - lastTime)/1000;
      lastTime = now;

      // rotation
      if (keys.left)  angle -= angularSpeed * dt;
      if (keys.right) angle += angularSpeed * dt;

      // forward/back
      let vx = 0, vy = 0;
      if (keys.up)   { vx += Math.cos(angle)*speed; vy += Math.sin(angle)*speed; }
      if (keys.down) { vx -= Math.cos(angle)*speed; vy -= Math.sin(angle)*speed; }

      const style = getComputedStyle(player);
      let x = parseFloat(style.left), y = parseFloat(style.top);
      x = Math.min(Math.max(0, x + vx*dt), window.innerWidth  - player.clientWidth);
      y = Math.min(Math.max(0, y + vy*dt), window.innerHeight - player.clientHeight);

      player.style.left = x + 'px';
      player.style.top  = y + 'px';
      player.style.transform = `rotate(${angle}rad)`;

      requestAnimationFrame(update);
    }
    requestAnimationFrame(update);

    // reload on resize to recalc sizes
    window.addEventListener('resize', () => location.reload());
  </script>
</body>
</html>
